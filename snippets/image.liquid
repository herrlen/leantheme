{% doc %}
  Renders a responsive image that might be wrapped in a link.
  Integrates with image-alt.liquid for automatic ALT text generation.

  When `width`, `height` and `crop` are provided, the image will be rendered
  with a fixed aspect ratio.

  @param {image} image - The image to be rendered
  @param {string} [url] - An optional destination URL for the image
  @param {string} [class] - Optional class to be added to the image wrapper
  @param {number} [width] - The highest resolution width of the image to be rendered
  @param {number} [height] - The highest resolution height of the image to be rendered
  @param {string} [crop] - The crop position of the image
  @param {string} [alt] - Manual ALT text override
  @param {string} [context] - Context for auto-ALT: 'product', 'collection', 'article', 'blog'
  @param {object} [product] - Product object for auto-ALT
  @param {object} [collection] - Collection object for auto-ALT
  @param {object} [article] - Article object for auto-ALT
  @param {number} [position] - Image position for galleries
  @param {string} [variant_title] - Variant title for auto-ALT
  @param {boolean} [decorative] - Set true for decorative images (empty ALT)

  @example
  {% render 'image', image: product.featured_image %}
  {% render 'image', image: product.featured_image, url: product.url, context: 'product', product: product %}
  {% render 'image', image: collection.image, context: 'collection', collection: collection %}
  {% render 'image', image: decorative_image, decorative: true %}
{% enddoc %}

{% liquid
  unless height
    assign width = width | default: image.width
  endunless

  if url
    assign wrapper = 'a'
  else
    assign wrapper = 'div'
  endif

  # Generate ALT text using centralized system
  capture image_alt_text
    render 'image-alt', image: image, fallback: alt, context: context, product: product, collection: collection, article: article, blog: blog, position: position, variant_title: variant_title, decorative: decorative
  endcapture
  assign image_alt_text = image_alt_text | strip
%}

<{{ wrapper }}
  class="image {{ class }}"
  {% if url %}
    href="{{ url }}"
  {% endif %}
>
  {%- if decorative -%}
    {{ image | image_url: width: width, height: height, crop: crop | image_tag: alt: '', role: 'presentation', aria-hidden: 'true' }}
  {%- else -%}
    {{ image | image_url: width: width, height: height, crop: crop | image_tag: alt: image_alt_text }}
  {%- endif -%}
</{{ wrapper }}>

{% stylesheet %}
  .image {
    display: block;
    position: relative;
    overflow: hidden;
    width: 100%;
    height: auto;
  }

  .image > img {
    width: 100%;
    height: auto;
    /* CLS Prevention: Aspect-ratio als Fallback */
    aspect-ratio: attr(width) / attr(height);
  }

  /* CLS Prevention: Platzhalter w√§hrend Laden */
  .image--loading {
    background-color: #f5f5f5;
  }
{% endstylesheet %}
