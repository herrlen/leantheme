{% comment %}
  Professional Product Page V2 (Blocks Edition)
  Features: Flexible Accordions via Blocks, Sticky Info, Variant Buttons
{% endcomment %}

<div class="product-section section-{{ section.id }}-padding">
  <div class="page-width">
    
    <div class="product-container">
      
      <div class="product-media-gallery">
        {%- for media in product.media -%}
          <div class="product-media-item">
            {% render 'product-media', media: media %}
          </div>
        {%- endfor -%}
      </div>

      <div class="product-info-wrapper">
        <div class="product-info-sticky">
          
          {%- for block in section.blocks -%}
            {%- case block.type -%}
              
              {%- when '@app' -%}
                {% render block %}
              
              {%- when 'title' -%}
                <div class="product-header" {{ block.shopify_attributes }}>
                  {%- if block.settings.show_vendor -%}
                    <span class="product-vendor">{{ product.vendor }}</span>
                  {%- endif -%}
                  <h1 class="product-title">{{ product.title }}</h1>
                </div>

              {%- when 'price' -%}
                <div class="product-price" id="price-{{ section.id }}" {{ block.shopify_attributes }}>
                  <span class="price-item regular-price">
                    {{ product.selected_or_first_available_variant.price | money }}
                  </span>
                  {% if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price %}
                    <span class="price-item compare-price">
                      {{ product.selected_or_first_available_variant.compare_at_price | money }}
                    </span>
                  {% endif %}
                </div>

              {%- when 'variant_picker' -%}
                <div {{ block.shopify_attributes }}>
                  <product-form class="product-form">
                    {% form 'product', product, id: 'product-form-installment', class: 'installment caption-large' %}
                      <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" id="selected-variant-id">
                      
                      {%- unless product.has_only_default_variant -%}
                        <div class="variant-picker">
                          {%- for option in product.options_with_values -%}
                            <fieldset class="variant-fieldset">
                              <legend class="variant-legend">{{ option.name }}</legend>
                              <div class="variant-options">
                                {%- for value in option.values -%}
                                  <input type="radio" id="{{ section.id }}-{{ option.name }}-{{ forloop.index0 }}"
                                        name="{{ option.name }}"
                                        value="{{ value | escape }}"
                                        form="product-form-installment"
                                        {% if option.selected_value == value %}checked{% endif %}
                                        class="variant-radio hidden-radio"
                                  >
                                  <label for="{{ section.id }}-{{ option.name }}-{{ forloop.index0 }}" class="variant-label">
                                    {{ value }}
                                  </label>
                                {%- endfor -%}
                              </div>
                            </fieldset>
                          {%- endfor -%}
                        </div>
                      {%- endunless -%}

                      <div class="product-actions">
                        {%- if block.settings.show_quantity -%}
                          <div class="quantity-wrapper">
                            <input type="number" name="quantity" value="1" min="1" class="quantity-input" aria-label="Menge">
                          </div>
                        {%- endif -%}
                        <button type="submit" name="add" class="add-to-cart-btn" 
                          {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}>
                          <span class="add-text">
                            {% if product.selected_or_first_available_variant.available %}In den Warenkorb{% else %}Ausverkauft{% endif %}
                          </span>
                        </button>
                      </div>
                      {% if block.settings.show_dynamic_checkout %}
                        <div class="dynamic-checkout">{{ form | payment_button }}</div>
                      {% endif %}
                    {% endform %}
                  </product-form>
                </div>

              {%- when 'description' -%}
                <div class="product-description rte" {{ block.shopify_attributes }}>
                  {{ product.description }}
                </div>

              {%- when 'accordion' -%}
                <details class="accordion-item" {{ block.shopify_attributes }} {% if block.settings.open_by_default %}open{% endif %}>
                  <summary class="accordion-header">
                    <span>
                      {%- if block.settings.icon != 'none' -%}
                        {%- endif -%}
                      {{ block.settings.heading | default: block.settings.page.title }}
                    </span>
                    <span class="icon-plus">+</span>
                  </summary>
                  <div class="accordion-content rte">
                    {{ block.settings.content }}
                    {{ block.settings.page.content }}
                  </div>
                </details>

            {%- endcase -%}
          {%- endfor -%}

        </div>
      </div>

    </div>
  </div>
</div>

{%- capture media_snippet -%}
  <img src="{{ media | img_url: '1200x' }}" alt="{{ media.alt | escape }}" width="1000" height="1000" loading="lazy" style="width:100%; height:auto;">
{%- endcapture -%}

<script>
  var productVariants = {{ product.variants | json }};
  document.addEventListener('DOMContentLoaded', function() {
    const radios = document.querySelectorAll('.variant-radio');
    const masterSelect = document.getElementById('selected-variant-id');
    const priceContainer = document.querySelector('.regular-price');
    const btnText = document.querySelector('.add-text');
    const btn = document.querySelector('.add-to-cart-btn');

    function updateVariant() {
      const selectedOptions = Array.from(document.querySelectorAll('.variant-radio:checked')).map(el => el.value);
      const matchedVariant = productVariants.find(variant => {
        return variant.options.every((option, index) => option === selectedOptions[index]);
      });

      if (matchedVariant) {
        masterSelect.value = matchedVariant.id;
        priceContainer.innerText = (matchedVariant.price / 100).toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('variant', matchedVariant.id);
        window.history.replaceState({}, '', newUrl);

        if (matchedVariant.available) {
          btn.disabled = false;
          btnText.innerText = "In den Warenkorb";
        } else {
          btn.disabled = true;
          btnText.innerText = "Ausverkauft";
        }
      } else {
        btn.disabled = true;
        btnText.innerText = "Nicht verfügbar";
      }
    }
    radios.forEach(radio => radio.addEventListener('change', updateVariant));
  });
</script>

<style>
  .section-{{ section.id }}-padding { padding-top: 40px; padding-bottom: 60px; }
  .page-width { max-width: 1300px; margin: 0 auto; padding: 0 20px; }
  .product-container { display: grid; grid-template-columns: 1fr; gap: 40px; }
  @media(min-width: 990px) {
    .product-container { grid-template-columns: 1.5fr 1fr; gap: 60px; }
    .product-info-sticky { position: sticky; top: 30px; }
  }
  .product-media-gallery { display: grid; gap: 10px; }
  @media(max-width: 989px) {
    .product-media-gallery { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 20px; }
    .product-media-item { flex: 0 0 90%; scroll-snap-align: center; margin-right: 10px; }
  }
  .product-media-item img { display: block; width: 100%; border-radius: 4px; }
  
  .product-vendor { text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.8rem; color: #666; margin-bottom: 10px; display: block; }
  .product-title { font-size: 2.2rem; margin: 0 0 15px; line-height: 1.2; }
  .product-price { font-size: 1.3rem; font-weight: 600; margin-bottom: 30px; }
  .compare-price { text-decoration: line-through; color: #888; margin-left: 10px; font-weight: normal; font-size: 1.1rem; }

  /* Variants */
  .variant-fieldset { border: none; padding: 0; margin: 0 0 20px; }
  .variant-legend { font-size: 0.9rem; font-weight: 600; margin-bottom: 10px; }
  .variant-options { display: flex; flex-wrap: wrap; gap: 10px; }
  .hidden-radio { position: absolute; opacity: 0; width: 0; height: 0; }
  .variant-label { padding: 10px 20px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; background: #fff; min-width: 50px; text-align: center; }
  .hidden-radio:checked + .variant-label { border-color: #000; background: #000; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

  /* Actions */
  .product-actions { display: flex; gap: 15px; margin-top: 30px; margin-bottom: 20px; }
  .quantity-input { width: 70px; padding: 15px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
  .add-to-cart-btn { flex-grow: 1; background: #000; color: #fff; border: none; border-radius: 4px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; transition: opacity 0.3s; }
  .add-to-cart-btn:hover { opacity: 0.9; }
  .add-to-cart-btn:disabled { background: #ccc; cursor: not-allowed; }

  /* Accordions Block Style */
  .accordion-item { border-top: 1px solid #eee; border-bottom: 1px solid #eee; margin-top: -1px; }
  .accordion-header { padding: 15px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; list-style: none; }
  .accordion-header::-webkit-details-marker { display: none; }
  .accordion-content { padding-bottom: 20px; line-height: 1.6; color: #444; }
  .icon-plus { font-size: 1.5rem; line-height: 1; font-weight: 300; transition: transform 0.3s; }
  details[open] .icon-plus { transform: rotate(45deg); }
  
  .product-description { margin-bottom: 30px; line-height: 1.6; }
</style>

{% schema %}
{
  "name": "Produkt Details",
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "title",
      "name": "Titel & Vendor",
      "limit": 1,
      "settings": [
        { "type": "checkbox", "id": "show_vendor", "label": "Vendor anzeigen", "default": true }
      ]
    },
    {
      "type": "price",
      "name": "Preis",
      "limit": 1
    },
    {
      "type": "variant_picker",
      "name": "Varianten & Kaufen",
      "limit": 1,
      "settings": [
        { "type": "checkbox", "id": "show_quantity", "label": "Mengenfeld anzeigen", "default": true },
        { "type": "checkbox", "id": "show_dynamic_checkout", "label": "PayPal Button anzeigen", "default": true }
      ]
    },
    {
      "type": "description",
      "name": "Produktbeschreibung",
      "limit": 1
    },
    {
      "type": "accordion",
      "name": "Klapptext (Accordion)",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Überschrift",
          "default": "Details"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Inhalt"
        },
        {
          "type": "page",
          "id": "page",
          "label": "Inhalt von Seite (Optional)",
          "info": "Zeigt den Inhalt einer statischen Seite an (z.B. Größentabelle)"
        },
        {
          "type": "checkbox",
          "id": "open_by_default",
          "label": "Standardmäßig geöffnet",
          "default": false
        }
      ]
    }
  ],
  "settings": []
}
{% endschema %}