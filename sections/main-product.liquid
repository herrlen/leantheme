{% comment %}
  Lean Product Page (Hybrid Gallery)
  Features: Mobile Snap-Scroll (Wischen), Desktop Pfeil-Navigation (Klicken), Accordion Info, Sticky Mobile ATC
{% endcomment %}

<section class="product-section section-{{ section.id }}-padding" id="MainProduct-{{ section.id }}">
  <div class="page-width">
    <div class="product-grid">
      
      <div class="product-media-wrapper">
        
        <div class="gallery-container relative">
          <div class="product-gallery snap-scroll" id="Gallery-{{ section.id }}">
            {%- if product.media.size > 0 -%}
              {%- for media in product.media -%}
                <div class="gallery-item">
                  <img
                    src="{{ media | image_url: width: 1000 }}"
                    alt="{{ media.alt | escape }}"
                    width="{{ media.width }}"
                    height="{{ media.height }}"
                    loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                    class="gallery-img"
                  >
                </div>
              {%- endfor -%}
            {%- else -%}
               <div class="gallery-item">
                 {{ 'product-1' | placeholder_svg_tag: 'gallery-img placeholder' }}
               </div>
            {%- endif -%}
          </div>

          {% if product.media.size > 1 %}
            <button class="gallery-nav nav-prev small-hide" aria-label="Zurück" onclick="scrollGallery(-1)">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <button class="gallery-nav nav-next small-hide" aria-label="Weiter" onclick="scrollGallery(1)">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
            </button>
          {% endif %}
        </div>

        <div class="gallery-indicator medium-up-hide">
          {% if product.media.size > 1 %}
          <span class="swipe-hint">← Wischen →</span>
          {% endif %}
        </div>
      </div>

      <div class="product-info-wrapper">
        <div class="product-info-container">
          
          <div class="product-meta">
            {%- if section.settings.show_vendor -%}
              <span class="product-vendor">{{ product.vendor }}</span>
            {%- endif -%}
            <h1 class="product-title">{{ product.title }}</h1>
            
            <div class="product-price-container" id="price-{{ section.id }}">
              <span class="price-regular">{{ product.selected_or_first_available_variant.price | money }}</span>
              {%- if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price -%}
                <s class="price-compare">{{ product.selected_or_first_available_variant.compare_at_price | money }}</s>
                <span class="badge-sale">Sale</span>
              {%- endif -%}
            </div>
          </div>

          {%- form 'product', product, id: 'product-form', class: 'product-form' -%}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" id="selected-variant-id">

            {%- unless product.has_only_default_variant -%}
              <div class="variant-picker">
                {%- for option in product.options_with_values -%}
                  <fieldset class="variant-option">
                    <legend class="option-label">{{ option.name }}</legend>
                    <div class="option-values">
                      {%- for value in option.values -%}
                        <input type="radio" id="{{ section.id }}-{{ option.name }}-{{ forloop.index }}"
                          name="{{ option.name }}"
                          value="{{ value | escape }}"
                          {% if option.selected_value == value %}checked{% endif %}
                          class="variant-radio-input"
                          onchange="updateVariant(this)">
                        <label for="{{ section.id }}-{{ option.name }}-{{ forloop.index }}" class="variant-radio-label">
                          {{ value }}
                        </label>
                      {%- endfor -%}
                    </div>
                  </fieldset>
                {%- endfor -%}
              </div>
            {%- endunless -%}

            <div class="quantity-selector">
              <label for="Quantity-{{ section.id }}">Menge</label>
              <div class="qty-wrapper">
                <input type="number" name="quantity" id="Quantity-{{ section.id }}" value="1" min="1" class="qty-input">
              </div>
            </div>

            <div class="product-buttons">
              <button type="submit" name="add" class="btn-add-to-cart full-width" 
                {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}>
                {%- if product.selected_or_first_available_variant.available -%}
                  In den Warenkorb
                {%- else -%}
                  Ausverkauft
                {%- endif -%}
              </button>
            </div>
          {%- endform -%}
          <div class="product-accordions">
            {%- if product.description != blank -%}
              <details class="prod-details" open>
                <summary>Beschreibung <span class="icon-plus">+</span></summary>
                <div class="details-content rte">{{ product.description }}</div>
              </details>
            {%- endif -%}
            
            <details class="prod-details">
              <summary>Versand & Rückgabe <span class="icon-plus">+</span></summary>
              <div class="details-content">
                <p>Kostenloser Versand ab 50€. Wir versenden innerhalb von 24h.</p>
              </div>
            </details>
          </div>

        </div>
      </div>

    </div>
  </div>

  <div class="sticky-atc-bar medium-up-hide">
    <div class="sticky-info">
      <span class="sticky-title">{{ product.title | truncate: 20 }}</span>
      <span class="sticky-price">{{ product.selected_or_first_available_variant.price | money }}</span>
    </div>
    <button type="button" class="btn-sticky-add" onclick="document.querySelector('.btn-add-to-cart').click()">
      In den Warenkorb
    </button>
  </div>

</section>

<script>
  // 1. Varianten Logik
  var productVariants = {{ product.variants | json }};

  function updateVariant(input) {
    var form = document.querySelector('.product-form');
    var selectedOptions = [];
    form.querySelectorAll('.variant-radio-input:checked').forEach(function(radio) {
      selectedOptions.push(radio.value);
    });

    var matchedVariant = productVariants.find(function(variant) {
      return variant.options.every(function(option, index) {
        return option === selectedOptions[index];
      });
    });

    if (matchedVariant) {
      document.getElementById('selected-variant-id').value = matchedVariant.id;
      
      var priceHtml = formatMoney(matchedVariant.price);
      if(matchedVariant.compare_at_price > matchedVariant.price) {
         priceHtml += ' <s class="price-compare">' + formatMoney(matchedVariant.compare_at_price) + '</s> <span class="badge-sale">Sale</span>';
      }
      document.querySelector('.product-price-container').innerHTML = priceHtml;
      
      var btn = document.querySelector('.btn-add-to-cart');
      if (matchedVariant.available) {
        btn.disabled = false;
        btn.textContent = 'In den Warenkorb';
      } else {
        btn.disabled = true;
        btn.textContent = 'Ausverkauft';
      }
      document.querySelector('.sticky-price').textContent = formatMoney(matchedVariant.price);
    }
  }

  function formatMoney(cents) {
    return (cents / 100).toFixed(2).replace('.', ',') + ' €'; 
  }

  // 2. NEU: Galerie Pfeil Logik (Simples Scrolling)
  function scrollGallery(direction) {
    const gallery = document.getElementById('Gallery-{{ section.id }}');
    // Scrollt um die Breite des Containers nach links (-1) oder rechts (+1)
    const scrollAmount = gallery.clientWidth * direction;
    gallery.scrollBy({
      left: scrollAmount,
      behavior: 'smooth'
    });
  }
</script>

<style>
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
  }
  .page-width { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

  /* Layout */
  .product-grid { display: grid; gap: 40px; }
  @media(min-width: 990px) {
    .product-grid { grid-template-columns: 1.5fr 1fr; align-items: start; }
    .product-info-container { position: sticky; top: 30px; }
  }

  /* === HYBRID GALLERY CSS === */
  .relative { position: relative; }

  .product-gallery {
    display: flex;
    overflow-x: auto; /* Ermöglicht horizontales Scrollen */
    gap: 10px;
    scroll-snap-type: x mandatory; /* Das magische Einrasten beim Wischen */
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Scrollbar verstecken (Firefox) */
    scroll-behavior: smooth;
  }
  .product-gallery::-webkit-scrollbar { display: none; /* Scrollbar verstecken (Chrome/Safari) */ }
  
  .gallery-item {
    flex: 0 0 100%; /* Mobile: 1 Bild nimmt 100% Breite */
    scroll-snap-align: start; /* Bild rastet am Anfang ein */
  }
  .gallery-img { width: 100%; height: auto; border-radius: 8px; display: block; object-fit: cover; aspect-ratio: 3/4; }
  
  /* Navigations Pfeile */
  .gallery-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255,255,255,0.8);
    border: 1px solid rgba(0,0,0,0.1);
    width: 40px; height: 40px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    z-index: 2;
    transition: all 0.2s;
    color: #333;
  }
  .gallery-nav:hover { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .nav-prev { left: 10px; }
  .nav-next { right: 10px; }

  /* Desktop Anpassung */
  @media(min-width: 990px) {
    /* Auf Desktop zeigen wir auch nur 1 Bild, aber mit Pfeilen */
    .gallery-img { aspect-ratio: auto; /* Natürliches Format auf Desktop */ }
  }

  .gallery-indicator { text-align: center; font-size: 0.8rem; color: #888; margin-top: 10px; }

  /* RESTLICHE STYLES (Info, Buttons, etc.) - Unverändert */
  .product-vendor { text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.1em; opacity: 0.6; }
  .product-title { font-size: 2rem; margin: 5px 0 15px 0; line-height: 1.1; }
  
  .product-price-container { font-size: 1.5rem; display: flex; align-items: center; gap: 10px; margin-bottom: 25px; }
  .price-regular { font-weight: 700; }
  .price-compare { color: #888; font-size: 1rem; }
  .badge-sale { background: #d32f2f; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }

  .variant-picker { margin-bottom: 20px; }
  .option-label { font-weight: 600; margin-bottom: 8px; display: block; font-size: 0.9rem; }
  .option-values { display: flex; flex-wrap: wrap; gap: 10px; }
  
  .variant-radio-input { display: none; }
  .variant-radio-label {
    padding: 10px 18px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s;
  }
  .variant-radio-input:checked + .variant-radio-label {
    background: #000; color: #fff; border-color: #000;
  }

  .quantity-selector { margin-bottom: 20px; }
  .qty-input { padding: 10px; width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
  
  .btn-add-to-cart {
    width: 100%; padding: 16px; background: #000; color: #fff; border: none; border-radius: 4px;
    font-size: 1rem; font-weight: bold; cursor: pointer; transition: opacity 0.2s;
  }
  .btn-add-to-cart:hover { opacity: 0.9; }
  .btn-add-to-cart:disabled { background: #ccc; cursor: not-allowed; }

  .product-accordions { margin-top: 30px; border-top: 1px solid #eee; }
  .prod-details { border-bottom: 1px solid #eee; }
  .prod-details summary {
    padding: 15px 0; cursor: pointer; list-style: none; font-weight: 600;
    display: flex; justify-content: space-between; align-items: center;
  }
  .prod-details summary::-webkit-details-marker { display: none; }
  .details-content { padding-bottom: 15px; color: #555; line-height: 1.6; }

  .sticky-atc-bar {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: #fff; border-top: 1px solid #eee;
    padding: 12px 20px; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    display: flex; align-items: center; justify-content: space-between; gap: 15px;
    transform: translateY(100%); animation: slideUp 0.3s forwards 0.5s;
  }
  
  @keyframes slideUp { to { transform: translateY(0); } }

  .sticky-info { display: flex; flex-direction: column; font-size: 0.8rem; }
  .sticky-title { font-weight: 600; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .btn-sticky-add {
    background: #000; color: #fff; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold;
  }

  .medium-up-hide { display: block; }
  .small-hide { display: none; }
  @media(min-width: 990px) { 
    .medium-up-hide { display: none; } 
    .small-hide { display: flex; } /* Pfeile auf Desktop anzeigen */
  }

</style>

{% schema %}
{
  "name": "Produktseite",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Hersteller anzeigen",
      "default": true
    },
    {
      "type": "header",
      "content": "Abstände"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0, "max": 100, "step": 4, "default": 40, "label": "Abstand Oben"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0, "max": 100, "step": 4, "default": 40, "label": "Abstand Unten"
    }
  ],
  "presets": [
    {
      "name": "Produktseite Standard"
    }
  ]
}
{% endschema %}