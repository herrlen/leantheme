{% comment %}
  Lean Featured Collection (Hybrid: Snap-Scroll & Grid)
  Features: 
  - Mobile: Horizontales Wischen (Spart Platz, App-Feeling)
  - Desktop: Wahlweise Wischen oder Raster (Grid)
  - UX: Hover-Bildwechsel, Sale-Badges, Smart Pricing
{% endcomment %}

{%- liquid
  assign fc_has_video = false
  if section.settings.video_bg_enabled
    if section.settings.video_bg != blank or section.settings.video_bg_url != blank
      assign fc_has_video = true
    endif
  endif
-%}

<div class="collection-snap section-{{ section.id }}-padding{% if fc_has_video %} collection-snap--has-video{% endif %}">
  {%- if fc_has_video -%}
    {%- render 'video-background',
      video_mp4: section.settings.video_bg,
      video_url: section.settings.video_bg_url,
      fallback_image: section.settings.video_bg_fallback,
      overlay_color: section.settings.video_bg_overlay_color,
      overlay_opacity: section.settings.video_bg_overlay_opacity,
      mobile_video: section.settings.video_bg_mobile,
      section_id: section.id
    -%}
  {%- endif -%}
  <div class="page-width">
    
    {%- if section.settings.title != blank -%}
      <div class="collection-header">
        <h2 class="collection-title {{ section.settings.heading_size }}">{{ section.settings.title }}</h2>
        {%- if section.settings.show_view_all and section.settings.collection != blank -%}
          <a href="{{ section.settings.collection.url }}" class="view-all-link">
            {{ section.settings.view_all_label }} <span aria-hidden="true">→</span>
          </a>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- assign collection = section.settings.collection -%}
    {%- assign product_limit = section.settings.products_to_show -%}

    <div class="product-container {% if section.settings.enable_desktop_slider %}snap-track-wrapper{% else %}grid-wrapper{% endif %}">
      <div class="{% if section.settings.enable_desktop_slider %}snap-track{% else %}grid-track desktop-grid-{{ section.settings.columns_desktop }}{% endif %}">
        
        {%- if collection != blank -%}
          {%- for product in collection.products limit: product_limit -%}
            <div class="product-card">
              <a href="{{ product.url }}" class="product-link">
                <div class="product-image-wrapper ratio-{{ section.settings.image_ratio }}">
                  {%- if product.featured_media -%}
                    {%- render 'image-lazy',
                      image: product.featured_media,
                      index: forloop.index,
                      eager_count: 4,
                      sizes: '(min-width: 1200px) 23vw, (min-width: 900px) 30vw, (min-width: 600px) 45vw, 70vw',
                      widths: '300,400,500,600',
                      class: 'product-img primary',
                      wrapper: false,
                      context: 'product',
                      product: product,
                      position: 1
                    -%}
                    {%- if product.media[1] != blank and section.settings.show_secondary_image -%}
                      {%- render 'image-lazy',
                        image: product.media[1],
                        lazy: true,
                        sizes: '(min-width: 1200px) 23vw, (min-width: 900px) 30vw, (min-width: 600px) 45vw, 70vw',
                        widths: '300,400,500,600',
                        class: 'product-img secondary',
                        wrapper: false,
                        context: 'product',
                        product: product,
                        position: 2
                      -%}
                    {%- endif -%}
                  {%- else -%}
                    {{ 'product-1' | placeholder_svg_tag: 'product-img placeholder' }}
                  {%- endif -%}

                  {%- if section.settings.show_badges -%}
                    <div class="badge-container">
                      {%- if product.available == false -%}
                        <span class="badge badge--soldout">Sold out</span>
                      {%- elsif product.compare_at_price > product.price -%}
                        <span class="badge badge--sale">Sale</span>
                      {%- endif -%}
                    </div>
                  {%- endif -%}

                  {%- if section.settings.show_quick_buy -%}
                    {% render 'quick-buy-button',
                      product: product,
                      button_style: section.settings.quick_buy_style,
                      button_text: section.settings.quick_buy_text,
                      show_quick_view: section.settings.show_quick_view,
                      position: 'overlay'
                    %}
                  {%- endif -%}
                </div>

                <div class="product-info">
                  <h3 class="product-title">{{ product.title }}</h3>
                  <div class="product-price">
                    {%- if product.compare_at_price > product.price -%}
                      <span class="price-compare">{{ product.compare_at_price | money }}</span>
                      <span class="price-regular sale">{{ product.price | money }}</span>
                    {%- else -%}
                      <span class="price-regular">{{ product.price | money }}</span>
                    {%- endif -%}
                  </div>
                </div>
              </a>
            </div>
          {%- endfor -%}
        
        {%- else -%}
          {% comment %} Onboarding (Platzhalter) {% endcomment %}
          {%- for i in (1..4) -%}
            <div class="product-card">
              <div class="product-image-wrapper ratio-{{ section.settings.image_ratio }}">
                {{ 'product-' | append: i | placeholder_svg_tag: 'product-img placeholder' }}
              </div>
              <div class="product-info">
                <h3 class="product-title">Beispiel Produkt {{ i }}</h3>
                <div class="product-price">19,99 €</div>
              </div>
            </div>
          {%- endfor -%}
        {%- endif -%}

        {% if section.settings.enable_desktop_slider %}
          <div class="snap-spacer"></div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    background-color: {{ section.settings.bg_color }};
  }

  .collection-snap--has-video {
    position: relative;
    overflow: hidden;
  }
  .collection-snap--has-video .page-width {
    position: relative;
    z-index: 4;
  }

  .page-width { max-width: 1300px; margin: 0 auto; padding: 0 20px; }

  /* Header */
  .collection-header {
    display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 25px;
  }
  .collection-title { margin: 0; line-height: 1.1; }
  .collection-title.h2 { font-size: 2rem; }
  .collection-title.h3 { font-size: 1.5rem; }
  
  .view-all-link { text-decoration: none; color: inherit; font-size: 0.9rem; opacity: 0.7; }
  .view-all-link:hover { opacity: 1; text-decoration: underline; }

  /* === LAYOUT LOGIC === */
  
  /* 1. SLIDER MODE (Always on Mobile, Optional on Desktop) */
  .snap-track-wrapper { margin-right: -20px; overflow: hidden; }
  
  .snap-track {
    display: flex; gap: 20px; overflow-x: auto;
    scroll-snap-type: x mandatory; 
    padding-bottom: 30px; padding-right: 20px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: #000000 transparent; /* Firefox */
  }
  
  /* Slider Scrollbar Styling */
  .snap-track::-webkit-scrollbar { height: 3px; }
  .snap-track::-webkit-scrollbar-track { background: transparent; }
  .snap-track::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
  .snap-track:hover::-webkit-scrollbar-thumb { background: #555; }

  .snap-track .product-card {
    flex: 0 0 70%; /* Mobile Peeking */
    scroll-snap-align: start;
    max-width: 320px;
  }
  
  @media(min-width: 600px) { .snap-track .product-card { flex: 0 0 45%; } }
  @media(min-width: 900px) { .snap-track .product-card { flex: 0 0 30%; } }
  @media(min-width: 1200px) { .snap-track .product-card { flex: 0 0 23%; } }

  .snap-spacer { flex: 0 0 1px; }

  /* 2. GRID MODE (Desktop Only Override) */
  @media(min-width: 990px) {
    .grid-track {
      display: grid; gap: 30px;
    }
    .desktop-grid-3 { grid-template-columns: repeat(3, 1fr); }
    .desktop-grid-4 { grid-template-columns: repeat(4, 1fr); }
    .desktop-grid-5 { grid-template-columns: repeat(5, 1fr); }
    
    /* Reset Grid Card width */
    .grid-track .product-card { max-width: none; flex: unset; }
  }
  
  /* Wenn Desktop Slider aktiv ist, ignorieren wir Grid styles */

  /* === CARD DESIGN === */
  .product-link { text-decoration: none; color: inherit; display: block; }
  
  .product-image-wrapper {
    position: relative; background: #f4f4f4; border-radius: 0px; overflow: hidden; margin-bottom: 12px;
  }
  
  /* Aspect Ratios */
  .ratio-square { aspect-ratio: 1 / 1; }
  .ratio-portrait { aspect-ratio: 3 / 4; }
  .ratio-landscape { aspect-ratio: 16 / 9; }

  .product-img {
    width: 100%; height: 100%; object-fit: cover; transition: transform 0.6s ease;
  }
  
  /* Hover Effect */
  .product-image-wrapper:hover .product-img.primary { transform: scale(1.03); }
  .product-img.secondary {
    position: absolute; top: 0; left: 0; opacity: 0; z-index: 2;
  }
  .product-image-wrapper:hover .product-img.secondary { opacity: 1; transform: scale(1.03); }

  /* Badges */
  .badge-container { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 3; }
  .badge {
    padding: 4px 10px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #fff;
  }
  .badge--soldout { background: #333; }
  .badge--sale { background: #d32f2f; }

  /* Info */
  .product-title { font-size: 1rem; margin: 0 0 5px 0; font-weight: 500; }
  .product-price { font-size: 0.95rem; }
  .price-compare { text-decoration: line-through; opacity: 0.6; margin-right: 6px; font-size: 0.9em; }
  .price-regular.sale { color: #d32f2f; }
</style>

{% schema %}
{
  "name": "Featured Collection Pro",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Überschrift",
      "default": "Bestseller"
    },
    {
      "type": "select",
      "id": "heading_size",
      "label": "Überschrift Größe",
      "options": [
        { "value": "h2", "label": "Groß" },
        { "value": "h3", "label": "Mittel" }
      ],
      "default": "h2"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Kategorie wählen"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 4,
      "max": 12,
      "step": 1,
      "default": 8,
      "label": "Anzahl Produkte"
    },
    {
      "type": "header",
      "content": "Layout Desktop"
    },
    {
      "type": "checkbox",
      "id": "enable_desktop_slider",
      "label": "Slider auch auf Desktop nutzen",
      "default": true,
      "info": "Wenn deaktiviert, werden Produkte als Raster angezeigt."
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 3,
      "max": 5,
      "step": 1,
      "default": 4,
      "label": "Spalten im Raster (falls Slider aus)"
    },
    {
      "type": "header",
      "content": "Karten Design"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "Bildformat",
      "options": [
        { "value": "square", "label": "Quadratisch (1:1)" },
        { "value": "portrait", "label": "Portrait (3:4)" },
        { "value": "landscape", "label": "Landscape (16:9)" }
      ],
      "default": "portrait"
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "label": "Hover-Bild anzeigen",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_badges",
      "label": "Badges (Sale/Soldout)",
      "default": true
    },
    {
      "type": "header",
      "content": "Quick Buy"
    },
    {
      "type": "checkbox",
      "id": "show_quick_buy",
      "label": "Quick Buy Button anzeigen",
      "default": true
    },
    {
      "type": "select",
      "id": "quick_buy_style",
      "label": "Button Style",
      "options": [
        { "value": "icon", "label": "Nur Icon" },
        { "value": "text", "label": "Nur Text" },
        { "value": "text_and_icon", "label": "Icon + Text" }
      ],
      "default": "icon"
    },
    {
      "type": "text",
      "id": "quick_buy_text",
      "label": "Button Text",
      "default": "Schnellkauf"
    },
    {
      "type": "checkbox",
      "id": "show_quick_view",
      "label": "t:sections.featured-collection.settings.show_quick_view.label",
      "default": true,
      "info": "t:sections.featured-collection.settings.show_quick_view.info"
    },
    {
      "type": "header",
      "content": "Link"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "'Alle anzeigen' Link",
      "default": true
    },
    {
      "type": "text",
      "id": "view_all_label",
      "label": "Link Text",
      "default": "Alle ansehen"
    },
    {
      "type": "header",
      "content": "Video-Hintergrund"
    },
    {
      "type": "checkbox",
      "id": "video_bg_enabled",
      "label": "Video-Hintergrund aktivieren",
      "default": false
    },
    {
      "type": "video",
      "id": "video_bg",
      "label": "Video (MP4 Upload)"
    },
    {
      "type": "text",
      "id": "video_bg_url",
      "label": "Video URL (YouTube / Vimeo)"
    },
    {
      "type": "image_picker",
      "id": "video_bg_fallback",
      "label": "Video Fallback-Bild"
    },
    {
      "type": "checkbox",
      "id": "video_bg_mobile",
      "label": "Video auch auf Mobile",
      "default": false
    },
    {
      "type": "color",
      "id": "video_bg_overlay_color",
      "label": "Video Overlay-Farbe",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "video_bg_overlay_opacity",
      "min": 0,
      "max": 90,
      "step": 5,
      "unit": "%",
      "label": "Video Overlay-Stärke",
      "default": 40
    },
    {
      "type": "header",
      "content": "Farben & Abstand"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Hintergrund",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Abstand Oben",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Abstand Unten",
      "default": 60
    }
  ],
  "presets": [
    {
      "name": "Featured Collection Pro"
    }
  ]
}
{% endschema %}